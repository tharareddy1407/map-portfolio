<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Map Portfolio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#555; --card:#fff;
      --shadow:0 12px 30px rgba(0,0,0,.18);
      --pill:#fff; --pillText:#111; --border:rgba(0,0,0,.10);
    }
    body.dark{
      --bg:#0b1220; --text:#e7eefc; --muted:rgba(231,238,252,.75); --card:#121a2b;
      --shadow:0 12px 30px rgba(0,0,0,.55);
      --pill:#121a2b; --pillText:#e7eefc; --border:rgba(255,255,255,.12);
    }

    html, body { height:100%; margin:0; background:var(--bg); }
    #map { height:100vh; width:100vw; }

    /* Put marker above line */
    .leaflet-overlay-pane { z-index: 400; }
    .leaflet-marker-pane  { z-index: 650; }

    /* Top bar */
    .topbar{
      position:fixed;
      top: env(safe-area-inset-top, 10px);
      left:12px; right:12px;
      z-index:9999;
      display:flex; justify-content:space-between; gap:10px;
      font-family: Arial, sans-serif;
      pointer-events:none;
    }
    .topbar .left,.topbar .right{ display:flex; gap:10px; pointer-events:auto; }
    .pill{
      background:var(--pill);
      color:var(--pillText);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      text-decoration:none;
    }
    .pill:active{ transform: translateY(1px); }

    /* Info panel */
    #panel{
      position:fixed;
      top: calc(env(safe-area-inset-top, 10px) + 64px);
      left:12px;
      z-index:9999;
      width:380px;
      max-width: calc(100% - 24px);
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      font-family: Arial, sans-serif;
      display:none;
    }
    #panel h3{ margin:0 0 8px; font-size:18px; }
    #panel .meta{ color:var(--muted); font-size:13px; margin-bottom:10px; }
    #panel .close{
      float:right; cursor:pointer; font-weight:700; font-size:18px;
      padding:4px 8px; border-radius:10px;
    }
    #panel a{ color:inherit; }

    @media (max-width: 768px){
      #panel{
        left:0; right:0;
        top:auto; bottom:0;
        width:auto; max-width:none;
        border-radius:18px 18px 0 0;
        padding: 14px 16px calc(16px + env(safe-area-inset-bottom, 0px));
        box-shadow: 0 -10px 30px rgba(0,0,0,.18);
      }
    }

    /* Keep zoom buttons lower than topbar */
    .leaflet-top.leaflet-left{ margin-top: calc(env(safe-area-inset-top, 10px) + 72px); }

    /* Travel emoji marker */
    .travel-emoji{
      font-size: 26px;
      transform: translate(-50%,-50%);
      will-change: transform;
      pointer-events:none;
    }

    /* âœ… CSS dash animation (no JS loops) */
    .route-line{
      stroke-linecap: round;
      stroke-linejoin: round;
      animation: dashmove 1.2s linear infinite;
    }
    @keyframes dashmove{
      to { stroke-dashoffset: -22; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="left">
      <div class="pill" id="tourBtn">â–¶ Tour</div>
      <div class="pill" id="themeBtn">ðŸŒ™ Dark</div>
    </div>
    <div class="right">
      <a class="pill" href="https://github.com/tharareddy1407" target="_blank" rel="noopener">GitHub</a>
    </div>
  </div>

  <div id="panel">
    <span class="close" id="closePanel">Ã—</span>
    <h3 id="panelTitle"></h3>
    <div class="meta" id="panelMeta"></div>
    <div id="panelBody"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ---------- SAFE COORD FIX (lat/lng swap protection) ----------
    function normalizeLatLng(ll){
      let a = Number(ll[0]), b = Number(ll[1]);
      // If first is longitude-like (>90) and second latitude-like (<=90), swap.
      if (Math.abs(a) > 90 && Math.abs(b) <= 90) [a, b] = [b, a];
      a = Math.max(-90, Math.min(90, a));
      b = Math.max(-180, Math.min(180, b));
      return [a, b]; // [lat, lng]
    }

    // ---------- STYLE SCALE ----------
    function routeWeight(z){
      if (z <= 4) return 2;
      if (z === 5) return 3;
      if (z === 6) return 4;
      if (z === 7) return 5;
      return 6;
    }
    function routeDash(z){
      if (z <= 4) return "8 10";
      if (z <= 6) return "10 10";
      return "12 10";
    }
    function pinRadius(z){
      if (z <= 4) return 6;
      if (z === 5) return 7;
      if (z === 6) return 8;
      return 10;
    }

    function densify(points, stepsPerSeg=220){
      const out = [];
      for (let i=0; i<points.length-1; i++){
        const a = points[i], b = points[i+1];
        for (let s=0; s<stepsPerSeg; s++){
          const t = s/stepsPerSeg;
          out.push([a[0] + (b[0]-a[0])*t, a[1] + (b[1]-a[1])*t]);
        }
      }
      out.push(points[points.length-1]);
      return out;
    }

    function chooseEmoji(from, to){
      const lonDiff = Math.abs(from[1] - to[1]);
      return lonDiff > 18 ? "âœˆï¸" : "ðŸš—";
    }

    // ---------- MAP ----------
    const usaBounds = L.latLngBounds([[24.5, -125.0], [49.8, -66.5]]);

    const map = L.map("map", {
      zoomControl: true,
      worldCopyJump: false,
      maxBounds: usaBounds.pad(0.15),
      maxBoundsViscosity: 1.0,
      minZoom: 4,
      maxZoom: 10,
      inertia: true
    });

    const lightTiles = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
      { attribution:"&copy; OpenStreetMap &copy; CARTO", maxZoom:18, noWrap:true }
    ).addTo(map);

    const darkTiles = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      { attribution:"&copy; OpenStreetMap &copy; CARTO", maxZoom:18, noWrap:true }
    );

    map.fitBounds(usaBounds, { animate:false });

    function refreshMapSize(){
      setTimeout(() => map.invalidateSize(true), 150);
    }
    window.addEventListener("resize", refreshMapSize);
    window.addEventListener("orientationchange", refreshMapSize);
    document.addEventListener("visibilitychange", () => { if (!document.hidden) refreshMapSize(); });

    // ---------- PANEL ----------
    const panel = document.getElementById("panel");
    const panelTitle = document.getElementById("panelTitle");
    const panelMeta  = document.getElementById("panelMeta");
    const panelBody  = document.getElementById("panelBody");
    document.getElementById("closePanel").addEventListener("click", () => {
      panel.style.display = "none";
      refreshMapSize();
    });

    function openPanel(key){
      const p = places[key];
      panelTitle.textContent = p.name;
      panelMeta.textContent  = p.city;
      panelBody.innerHTML    = p.html;
      panel.style.display = "block";
      refreshMapSize();
    }

    // ---------- DESTINATIONS ----------
    const places = {
      resume:     { name:"Resume",      city:"Denver, CO",      latlng: normalizeLatLng([39.7392, -104.9903]), color:"#3498db",
        html:`<ul><li>Highlights</li><li>Download link</li></ul>` },
      projects:   { name:"Projects",    city:"Los Angeles, CA", latlng: normalizeLatLng([34.0522, -118.2437]), color:"#e74c3c",
        html:`<ul><li>Map Portfolio</li><li>Other projects</li></ul>` },
      skills:     { name:"Tech Skills", city:"Dallas, TX",      latlng: normalizeLatLng([32.7767, -96.7970]),  color:"#2ecc71",
        html:`<ul><li>Python</li><li>SQL</li><li>AWS</li></ul>` },
      experience: { name:"Experience",  city:"New York, NY",    latlng: normalizeLatLng([40.7128, -74.0060]),  color:"#9b59b6",
        html:`<ul><li>Role 1</li><li>Role 2</li></ul>` },
      contact:    { name:"Contact Me",  city:"Atlanta, GA",     latlng: normalizeLatLng([33.7490, -84.3880]),  color:"#f1c40f",
        html:`<ul>
          <li>Email: <a href="mailto:yourname@email.com">yourname@email.com</a></li>
          <li>GitHub: <a target="_blank" rel="noopener" href="https://github.com/tharareddy1407">Profile</a></li>
        </ul>` }
    };

    // ---------- TRAVEL MARKER ----------
    const travelIcon = L.divIcon({
      className:"",
      html:`<div id="travelIcon" class="travel-emoji">ðŸš—</div>`,
      iconSize:[0,0]
    });

    let currentKey = "resume";
    let travelMarker = L.marker(places[currentKey].latlng, {
      icon: travelIcon,
      interactive: false,
      keyboard: false
    }).addTo(map);

    let routeLine = null;
    let animId = null;
    let travelLock = false; // prevents stuck overlaps

    function unlockMap(){
      // hard re-enable (fix "map stuck")
      map.dragging.enable();
      map.scrollWheelZoom.enable();
      map.doubleClickZoom.enable();
      map.touchZoom.enable();
      map.boxZoom.enable();
      map.keyboard.enable();
      if (map.tap) map.tap.enable();
    }

    function cancelTravel(){
      if (animId) cancelAnimationFrame(animId);
      animId = null;
      travelLock = false;
      unlockMap();
    }

    function rotateEmoji(path, idx){
      const a = path[idx];
      const b = path[Math.min(idx+1, path.length-1)];
      const dx = b[1]-a[1];
      const dy = b[0]-a[0];
      const angle = Math.atan2(dx, dy) * (180/Math.PI);
      const el = document.getElementById("travelIcon");
      if (el) el.style.transform = `translate(-50%,-50%) rotate(${angle}deg)`;
    }

    function animateAlong(path, durationMs, done){
      const t0 = performance.now();
      const last = path.length - 1;
      const ease = t => 1 - Math.pow(1 - t, 3);

      function step(now){
        const t = Math.min((now - t0) / durationMs, 1);
        const idx = Math.min(Math.floor(ease(t) * last), last);
        travelMarker.setLatLng(path[idx]);
        rotateEmoji(path, idx);
        if (t < 1) animId = requestAnimationFrame(step);
        else { animId = null; done?.(); }
      }
      animId = requestAnimationFrame(step);
    }

    function panSmoothTo(latlng){
      // Stable camera movement (NO fitBounds spam)
      map.panTo(latlng, { animate:true, duration:0.6 });
    }

    function travelTo(key){
      if (!places[key]) return;

      // if same point, just open
      if (key === currentKey){
        openPanel(key);
        return;
      }

      // safety: if already traveling, cancel and restart clean
      if (travelLock) cancelTravel();
      travelLock = true;

      const from = places[currentKey].latlng;
      const to   = places[key].latlng;

      // Update current key immediately (prevents tour deadlocks)
      currentKey = key;

      // Emoji
      const el = document.getElementById("travelIcon");
      if (el) el.textContent = chooseEmoji(from, to);

      // Remove old line
      if (routeLine) map.removeLayer(routeLine);

      const z = map.getZoom();
      routeLine = L.polyline([from, to], {
        weight: routeWeight(z),
        opacity: 0.95,
        dashArray: routeDash(z),
        className: "route-line"
      }).addTo(map);

      // Camera: pan (stable) instead of fitBounds (causes freeze)
      panSmoothTo(to);

      // Animate on same route
      const path = densify([from, to], 240);

      // hard timeout safety (never stuck)
      const failsafe = setTimeout(() => {
        travelLock = false;
        unlockMap();
      }, 4000);

      animateAlong(path, 1400, () => {
        clearTimeout(failsafe);
        travelLock = false;
        unlockMap();
        openPanel(key);
      });
    }

    // Update line + pins on zoom (prevents giant stuff when zoomed out)
    const pins = {};
    function rescale(){
      const z = map.getZoom();
      Object.values(pins).forEach(m => m.setStyle({ radius: pinRadius(z) }));
      if (routeLine) routeLine.setStyle({ weight: routeWeight(z), dashArray: routeDash(z) });
      unlockMap(); // extra safety
    }
    map.on("zoomend", rescale);

    // Create pins
    Object.entries(places).forEach(([key, p]) => {
      pins[key] = L.circleMarker(p.latlng, {
        radius: pinRadius(map.getZoom()),
        color:"#fff",
        weight:2,
        fillColor:p.color,
        fillOpacity:1
      }).addTo(map)
        .bindTooltip(p.name, { direction:"top", offset:[0,-8] })
        .on("click", () => {
          stopTour();
          travelTo(key);
        });
    });

    // ---------- TOUR (stable) ----------
    let tourOn = false;
    let tourTimer = null;
    const tourOrder = ["resume","projects","skills","experience","contact"];

    function stopTour(){
      tourOn = false;
      document.getElementById("tourBtn").textContent = "â–¶ Tour";
      if (tourTimer) clearTimeout(tourTimer);
      tourTimer = null;
    }

    function startTour(){
      tourOn = true;
      document.getElementById("tourBtn").textContent = "â¸ Tour";
      let i = 0;

      const step = () => {
        if (!tourOn) return;
        if (travelLock){
          tourTimer = setTimeout(step, 300);
          return;
        }
        travelTo(tourOrder[i % tourOrder.length]);
        i++;
        tourTimer = setTimeout(step, 2200);
      };

      step();
    }

    document.getElementById("tourBtn").addEventListener("click", () => {
      if (tourOn) stopTour();
      else startTour();
    });

    // ---------- THEME ----------
    let isDark = false;
    function toggleTheme(){
      isDark = !isDark;
      document.body.classList.toggle("dark", isDark);
      document.getElementById("themeBtn").textContent = isDark ? "â˜€ï¸ Light" : "ðŸŒ™ Dark";
      if (isDark){
        if (map.hasLayer(lightTiles)) map.removeLayer(lightTiles);
        if (!map.hasLayer(darkTiles)) darkTiles.addTo(map);
      } else {
        if (map.hasLayer(darkTiles)) map.removeLayer(darkTiles);
        if (!map.hasLayer(lightTiles)) lightTiles.addTo(map);
      }
      refreshMapSize();
    }
    document.getElementById("themeBtn").addEventListener("click", toggleTheme);

    // ---------- INIT ----------
    refreshMapSize();
    unlockMap();
    rescale();
    map.setView(places.resume.latlng, 6, { animate:false });
    openPanel("resume");

    // If user touches map while traveling, cancel travel cleanly (prevents stuck)
    ["mousedown","touchstart","wheel"].forEach(evt => {
      map.getContainer().addEventListener(evt, () => {
        if (travelLock && tourOn === false) cancelTravel();
      }, { passive:true });
    });
  </script>
</body>
</html>
